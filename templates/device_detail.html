<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/style.css" />
        <link rel="stylesheet" href="/static/css/navbar.css" />
        <link rel="stylesheet" href="/static/css/footer.css" />
        <link rel="stylesheet" href="/static/css/common.css" />
        <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap' rel='stylesheet'>
        <title>{{ device.name or device.hardware_id }} - Dezzip</title>
        <style>
            @media (max-width: 640px) {
                .flex-row.justify-between { flex-wrap: wrap; gap: 8px; }
                .flex-row.gap-sm { flex-wrap: wrap; }
                .page-header-content .title { flex-direction: column; align-items: flex-start; gap: 12px; }
            }
        </style>
    </head>
    <body>
        {% include 'navbar.html' %}

        <div class="page">
            <div class="page-header">
                <div class="page-header-content margined">
                    <div class="title">
                        <h1>{{ (device.name or device.hardware_id) | upper }}</h1>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-content margined">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="p-common" style="background-color: {{ 'var(--success-color)' if category == 'success' else 'var(--danger-color)' }}; border-radius: var(--common-border-radius); margin-bottom: var(--space-md);">
                            <p>{{ message }}</p>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="flex-col gap-common" style="max-width: 700px; padding: var(--space-md) 0;">
                <div class="p-common" style="background-color: var(--darker-background-color); border-radius: var(--common-border-radius);">
                    <h3 style="font-size: var(--font-size-lg);">Device Info</h3>
                    <div class="flex-col gap-common" style="margin-top: var(--space-md);">
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Hardware ID</p>
                            <p>{{ device.hardware_id }}</p>
                        </div>
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Name</p>
                            <p>{{ device.name or '—' }}</p>
                        </div>
                        <div class="flex-row justify-between items-center">
                            <p style="color: var(--text-muted);">Status</p>
                            <div class="flex-row items-center gap-sm">
                                <div style="width: 8px; height: 8px; border-radius: 50%; background-color: {{ '#4CAF50' if device.is_online() else 'var(--text-dim)' }};"></div>
                                <p>{{ 'Online' if device.is_online() else 'Offline' }}</p>
                            </div>
                        </div>
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Firmware</p>
                            <p>{{ device.firmware_version or 'Unknown' }}</p>
                        </div>
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Last Seen</p>
                            <p>{{ device.last_seen_at.strftime('%Y-%m-%d %H:%M') if device.last_seen_at else 'Never' }}</p>
                        </div>
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Registered</p>
                            <p>{{ device.registered_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                    </div>
                </div>

                <div class="p-common" style="background-color: var(--darker-background-color); border-radius: var(--common-border-radius);">
                    <div class="flex-row justify-between items-center">
                        <div>
                            <h3 style="font-size: var(--font-size-lg);">Assigned Gauge</h3>
                            <div style="margin-top: var(--space-sm);">
                            {% if device.assigned_post %}
                                <p><a href="/workshop/{{ device.assigned_post.id }}" style="color: var(--link-color);">{{ device.assigned_post.title }}</a></p>
                            {% else %}
                                <p style="color: var(--text-muted);">No gauge assigned</p>
                            {% endif %}
                            </div>
                        </div>
                        <a href="{{ url_for('devices.assign_gauge', device_id=device.id) }}">
                            <button class="btn btn-secondary btn-sm">Change</button>
                        </a>
                    </div>
                </div>

                <div class="p-common" style="background-color: var(--darker-background-color); border-radius: var(--common-border-radius);">
                    <div class="flex-row justify-between items-center">
                        <div>
                            <h3 style="font-size: var(--font-size-lg);">ESP Configuration</h3>
                            <p style="color: var(--text-muted); margin-top: var(--space-sm);">Customize colors, speed units, sensors, WiFi and more.</p>
                        </div>
                        <a href="{{ url_for('devices.configure_device', device_id=device.id) }}">
                            <button class="btn btn-primary btn-sm">Configure</button>
                        </a>
                    </div>
                </div>

                <div class="p-common" style="background-color: var(--darker-background-color); border-radius: var(--common-border-radius);">
                    <h3 style="font-size: var(--font-size-lg);">Firmware Update</h3>
                    <div class="flex-col gap-common" style="margin-top: var(--space-md);">
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Current Version</p>
                            <p id="fw-current">{{ device.firmware_version or 'v2.0.0' }}</p>
                        </div>
                        <div class="flex-row justify-between">
                            <p style="color: var(--text-muted);">Latest Available</p>
                            <p style="color: #4CAF50; font-weight: 600;" id="fw-latest">v3.0.0</p>
                        </div>
                        <div id="fw-status" style="display:none; padding:8px 12px; border-radius: var(--common-border-radius); font-size: var(--font-size-sm);"></div>
                        <div style="width:100%; height:8px; background:var(--glass-border, #eee); border-radius:4px; overflow:hidden; display:none;" id="fw-progress-wrap">
                            <div id="fw-progress-bar" style="height:100%; width:0%; background:var(--accent-color); border-radius:4px; transition:width 0.3s;"></div>
                        </div>
                        <div class="flex-row gap-sm">
                            <button class="btn btn-secondary btn-sm" onclick="checkFirmware()">Check for Updates</button>
                            <button class="btn btn-primary btn-sm" id="fw-install-btn" onclick="installFirmware()" style="display:none;">Install Update</button>
                        </div>
                    </div>
                </div>

                <div class="p-common" style="background-color: var(--darker-background-color); border-radius: var(--common-border-radius);">
                    <h3 style="font-size: var(--font-size-lg);">API Token</h3>
                    <div style="margin-top: var(--space-md);">
                    {% if active_token %}
                        <p style="color: var(--text-muted);">Active token ending in: <strong style="color: var(--text-color);">...{{ active_token.token[-8:] }}</strong></p>
                        <p style="color: var(--text-dim); font-size: var(--font-size-xs); margin-top: var(--space-xs);">Created {{ active_token.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% else %}
                        <p style="color: var(--accent-color);">No active token. Generate one below.</p>
                    {% endif %}
                    </div>
                    <form action="{{ url_for('devices.regenerate_token', device_id=device.id) }}" method="POST" style="margin-top: var(--space-md);">
                        <button type="submit" class="btn btn-secondary btn-sm" onclick="return confirm('This will invalidate the current token. Your ESP32 will need to be updated. Continue?');">Regenerate Token</button>
                    </form>
                </div>

                <div class="p-common" style="background-color: var(--darker-background-color); border-radius: var(--common-border-radius); border: 1px solid var(--danger-color);">
                    <div class="flex-row justify-between items-center">
                        <div>
                            <h3 style="color: var(--accent-color); font-size: var(--font-size-lg);">Danger Zone</h3>
                            <p style="color: var(--text-muted); margin-top: var(--space-sm);">Permanently remove this device and revoke all tokens.</p>
                        </div>
                        <form action="{{ url_for('devices.delete_device', device_id=device.id) }}" method="POST">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure? This cannot be undone.');">Delete Device</button>
                        </form>
                    </div>
                </div>

                <a href="{{ url_for('devices.my_devices') }}">
                    <button class="btn btn-ghost" style="margin-top: var(--space-sm);">Back to Devices</button>
                </a>
            </div>
        </div>

        {% include 'footer.html' %}

        <script>
        function checkFirmware() {
            const status = document.getElementById('fw-status');
            status.style.display = 'block';
            status.style.background = 'var(--lavender-light, #f0f0ff)';
            status.style.color = 'var(--text-color)';
            status.textContent = 'Checking for updates...';
            setTimeout(() => {
                const current = document.getElementById('fw-current').textContent;
                const latest = document.getElementById('fw-latest').textContent;
                if (current !== latest) {
                    status.style.background = '#E8F5E9';
                    status.style.color = '#2E7D32';
                    status.textContent = '✓ Update available: ' + latest;
                    document.getElementById('fw-install-btn').style.display = 'inline-block';
                } else {
                    status.style.background = '#E8F5E9';
                    status.style.color = '#2E7D32';
                    status.textContent = '✓ Your firmware is up to date.';
                }
            }, 1500);
        }
        function installFirmware() {
            const status = document.getElementById('fw-status');
            const wrap = document.getElementById('fw-progress-wrap');
            const bar = document.getElementById('fw-progress-bar');
            document.getElementById('fw-install-btn').disabled = true;
            wrap.style.display = 'block';
            status.textContent = 'Downloading firmware...';
            status.style.background = '#FFF3E0'; status.style.color = '#E65100';
            let pct = 0;
            const interval = setInterval(() => {
                pct += Math.random() * 15;
                if (pct >= 100) { pct = 100; clearInterval(interval); }
                bar.style.width = pct + '%';
                if (pct < 50) status.textContent = 'Downloading firmware... ' + Math.round(pct) + '%';
                else if (pct < 90) status.textContent = 'Flashing device... ' + Math.round(pct) + '%';
                else if (pct >= 100) {
                    status.textContent = '✓ Firmware updated to ' + document.getElementById('fw-latest').textContent;
                    status.style.background = '#E8F5E9'; status.style.color = '#2E7D32';
                    document.getElementById('fw-current').textContent = document.getElementById('fw-latest').textContent;
                    document.getElementById('fw-install-btn').style.display = 'none';
                }
            }, 300);
        }
        </script>
    </body>
</html>
