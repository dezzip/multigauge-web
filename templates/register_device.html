<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/static/css/style.css" />
        <link rel="stylesheet" href="/static/css/navbar.css" />
        <link rel="stylesheet" href="/static/css/footer.css" />
        <link rel="stylesheet" href="/static/css/common.css" />
        <link href='https://fonts.googleapis.com/css?family=Inter:wght@300;400;500;600;700' rel='stylesheet'>
        <title>Register Device</title>
        <style>
            .setup-container {
                max-width: 560px;
                margin: 0 auto;
                padding: var(--space-lg) var(--space-md);
            }

            /* Steps indicator */
            .steps-indicator {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0;
                margin-bottom: var(--space-xl);
            }
            .step-dot {
                width: 36px; height: 36px;
                border-radius: 50%;
                border: var(--brutal-border);
                background: var(--light-background-color);
                display: flex; align-items: center; justify-content: center;
                font-size: 14px; font-weight: 700;
                color: var(--text-muted);
                transition: all .25s;
                flex-shrink: 0;
            }
            .step-dot.active {
                background: var(--accent-color);
                color: #fff;
                box-shadow: var(--brutal-shadow-sm);
            }
            .step-dot.done {
                background: var(--success-color);
                color: #fff;
            }
            .step-line {
                width: 60px; height: 2px;
                background: var(--glass-border);
                transition: background .25s;
            }
            .step-line.done { background: var(--success-color); }

            /* Cards */
            .setup-card {
                background: var(--card-bg);
                border: var(--brutal-border);
                border-radius: var(--brutal-radius);
                box-shadow: var(--brutal-shadow);
                padding: 32px;
                display: none;
            }
            .setup-card.active { display: block; }

            .setup-card h2 {
                font-size: 22px;
                margin: 0 0 6px;
            }
            .setup-card .subtitle {
                font-size: 14px;
                color: var(--text-muted);
                margin-bottom: 28px;
            }

            /* Scan button */
            .scan-btn {
                width: 100%;
                padding: 16px;
                font-size: 15px;
                font-weight: 700;
                font-family: inherit;
                border: var(--brutal-border);
                border-radius: var(--brutal-radius);
                background: var(--accent-color);
                color: #fff;
                cursor: pointer;
                box-shadow: var(--brutal-shadow);
                transition: all .15s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            .scan-btn:hover {
                box-shadow: var(--brutal-shadow-hover);
                transform: translate(-1px, -1px);
            }
            .scan-btn:active {
                box-shadow: var(--brutal-shadow-active);
                transform: translate(2px, 2px);
            }
            .scan-btn:disabled {
                opacity: .5;
                cursor: not-allowed;
                transform: none;
                box-shadow: var(--brutal-shadow);
            }

            /* Spinner */
            .spinner {
                width: 18px; height: 18px;
                border: 3px solid rgba(255,255,255,.3);
                border-top: 3px solid #fff;
                border-radius: 50%;
                animation: spin .8s linear infinite;
                display: none;
            }
            @keyframes spin { to { transform: rotate(360deg) } }

            /* Status messages */
            .status-msg {
                margin-top: 16px;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 500;
                display: none;
            }
            .status-msg.info { display: block; background: var(--lavender-light); color: var(--accent-color); }
            .status-msg.success { display: block; background: var(--success-bg); color: #2E7D32; }
            .status-msg.error { display: block; background: var(--danger-bg); color: var(--danger-color); }

            /* Device found card */
            .device-found {
                margin-top: 20px;
                padding: 16px 20px;
                background: var(--light-background-color);
                border: var(--brutal-border);
                border-radius: 10px;
                display: none;
            }
            .device-found.show { display: block; animation: fadeIn .3s ease; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

            .device-found-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 6px;
            }
            .device-found-row:last-child { margin-bottom: 0; }
            .device-found-label {
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                color: var(--text-muted);
                letter-spacing: .5px;
            }
            .device-found-val {
                font-size: 14px;
                font-weight: 600;
                font-family: 'SF Mono', 'Fira Code', monospace;
            }

            /* WiFi form */
            .wifi-form {
                margin-top: 20px;
                display: none;
            }
            .wifi-form.show { display: block; }

            .form-group {
                margin-bottom: 16px;
            }
            .form-group label {
                display: block;
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                color: var(--text-muted);
                letter-spacing: .5px;
                margin-bottom: 6px;
            }
            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px 14px;
                font-size: 14px;
                font-family: inherit;
                border: var(--brutal-border);
                border-radius: 8px;
                background: var(--light-background-color);
                outline: none;
                transition: border-color .15s;
                box-sizing: border-box;
            }
            .form-group input:focus,
            .form-group select:focus {
                border-color: var(--accent-color);
            }

            .form-row-2 {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            /* Config step */
            .usage-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-top: 8px;
            }
            .usage-option {
                padding: 14px;
                border: var(--brutal-border);
                border-radius: 10px;
                text-align: center;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all .15s;
                background: var(--light-background-color);
            }
            .usage-option:hover {
                background: var(--lavender-light);
            }
            .usage-option.selected {
                background: var(--accent-color);
                color: #fff;
                box-shadow: var(--brutal-shadow-sm);
            }
            .usage-option .usage-icon {
                font-size: 24px;
                display: block;
                margin-bottom: 6px;
            }

            /* Buttons row */
            .btn-row {
                display: flex;
                gap: 10px;
                margin-top: 24px;
            }
            .btn-row .btn { flex: 1; text-align: center; }

            .manual-link {
                display: inline-block;
                margin-top: 20px;
                font-size: 13px;
                color: var(--text-muted);
                cursor: pointer;
                text-decoration: underline;
            }
            .manual-link:hover { color: var(--accent-color); }

            /* Manual form (fallback) */
            .manual-section {
                margin-top: 20px;
                display: none;
            }
            .manual-section.show { display: block; }

            /* Search select (car brand/model) */
            .search-select-wrap {
                position: relative;
            }
            .search-select-wrap input {
                width: 100%;
                padding: 10px 14px;
                font-size: 14px;
                font-family: inherit;
                border: var(--brutal-border);
                border-radius: 8px;
                background: var(--light-background-color);
                outline: none;
                box-sizing: border-box;
            }
            .search-select-wrap input:focus { border-color: var(--accent-color); }
            .search-dropdown {
                position: absolute;
                top: 100%;
                left: 0; right: 0;
                max-height: 200px;
                overflow-y: auto;
                background: var(--card-bg);
                border: var(--brutal-border);
                border-top: none;
                border-radius: 0 0 8px 8px;
                z-index: 100;
                display: none;
            }
            .search-dropdown.open { display: block; }
            .search-dropdown-item {
                padding: 10px 14px;
                font-size: 13px;
                cursor: pointer;
                transition: background .1s;
            }
            .search-dropdown-item:hover { background: var(--lavender-light); }

            /* Success screen */
            .success-screen { text-align: center; padding: 20px 0; }
            .success-icon { font-size: 56px; margin-bottom: 16px; }
            .success-screen h2 { margin-bottom: 10px; }
            .success-screen p { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }

            /* Skip WiFi link */
            .skip-link {
                display: block;
                text-align: center;
                margin-top: 12px;
                font-size: 13px;
                color: var(--text-muted);
                cursor: pointer;
            }
            .skip-link:hover { color: var(--accent-color); }

            @media (max-width: 600px) {
                .setup-container { padding: var(--space-md) var(--space-sm); }
                .setup-card { padding: 24px 18px; }
                .form-row-2 { grid-template-columns: 1fr; }
                .usage-grid { grid-template-columns: 1fr 1fr; }
                .step-line { width: 36px; }
            }
        </style>
    </head>
    <body>
        {% include 'navbar.html' %}

        <div class="page">
            <div class="page-header">
                <div class="page-header-content margined">
                    <div class="title">
                        <h1>Register Device</h1>
                    </div>
                </div>
            </div>
        </div>

        <div class="setup-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="status-msg {{ 'success' if category == 'success' else 'error' }}" style="margin-bottom:16px;">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Steps indicator -->
            <div class="steps-indicator">
                <div class="step-dot active" id="stepDot1">1</div>
                <div class="step-line" id="stepLine1"></div>
                <div class="step-dot" id="stepDot2">2</div>
                <div class="step-line" id="stepLine2"></div>
                <div class="step-dot" id="stepDot3">3</div>
            </div>

            <!-- ====== STEP 1: Bluetooth Scan & Connect ====== -->
            <div class="setup-card active" id="step1">
                <h2>üì° Connect your device</h2>
                <p class="subtitle">Scan for your Dezzip board via Bluetooth to begin setup.</p>

                <button class="scan-btn" id="scanBtn" onclick="startScan()">
                    <div class="spinner" id="scanSpinner"></div>
                    <span id="scanBtnText">Scan for Devices</span>
                </button>

                <div class="status-msg" id="scanStatus"></div>

                <div class="device-found" id="deviceFound">
                    <div class="device-found-row">
                        <span class="device-found-label">Board</span>
                        <span class="device-found-val" id="foundName">‚Äî</span>
                    </div>
                    <div class="device-found-row">
                        <span class="device-found-label">MAC Address</span>
                        <span class="device-found-val" id="foundMAC">‚Äî</span>
                    </div>
                    <div class="device-found-row">
                        <span class="device-found-label">Module</span>
                        <span class="device-found-val" id="foundModule">‚Äî</span>
                    </div>
                </div>

                <!-- WiFi push (after BLE connect) -->
                <div class="wifi-form" id="wifiForm">
                    <h3 style="font-size:15px;margin-bottom:14px;">üì∂ Push WiFi credentials</h3>
                    <div class="form-group">
                        <label>WiFi SSID</label>
                        <input type="text" id="wifiSSID" placeholder="Your WiFi network name" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>WiFi Password</label>
                        <input type="password" id="wifiPass" placeholder="WiFi password" autocomplete="off">
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-primary" onclick="pushWifi()">Send & Continue ‚Üí</button>
                    </div>
                    <span class="skip-link" onclick="goToStep(2)">Skip ‚Äì I'll configure WiFi later</span>
                    <div class="status-msg" id="wifiStatus" style="margin-top:12px;"></div>
                </div>

                <span class="manual-link" onclick="toggleManual()">Or enter MAC address manually</span>

                <div class="manual-section" id="manualSection">
                    <div class="form-group">
                        <label>Hardware ID (MAC)</label>
                        <input type="text" id="manualMAC" placeholder="e.g. AA:BB:CC:DD:EE:FF" autocomplete="off" style="text-transform:uppercase;">
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-primary" onclick="useManualMAC()">Continue ‚Üí</button>
                    </div>
                </div>
            </div>

            <!-- ====== STEP 2: Device Info ====== -->
            <div class="setup-card" id="step2">
                <h2>üöó About your setup</h2>
                <p class="subtitle">Tell us about your vehicle and how you'll use the gauge.</p>

                <div class="form-group">
                    <label>Device name</label>
                    <input type="text" id="deviceName" placeholder="e.g. My Dashboard, Daily Driver..." maxlength="40" autocomplete="off">
                </div>

                <div class="form-row-2">
                    <div class="form-group">
                        <label>Car Brand</label>
                        <div class="search-select-wrap" id="brandWrap">
                            <input type="text" id="brandInput" placeholder="Search brand..." autocomplete="off" oninput="filterBrands()" onfocus="openBrandDropdown()">
                            <div class="search-dropdown" id="brandDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Model</label>
                        <div class="search-select-wrap" id="modelWrap">
                            <input type="text" id="modelInput" placeholder="Select brand first..." autocomplete="off" disabled oninput="filterModels()" onfocus="openModelDropdown()">
                            <div class="search-dropdown" id="modelDropdown"></div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Year (optional)</label>
                    <input type="number" id="carYear" placeholder="e.g. 2019" min="1950" max="2030">
                </div>

                <div class="form-group">
                    <label>Usage</label>
                    <div class="usage-grid">
                        <div class="usage-option" onclick="selectUsage(this, 'daily')">
                            <span class="usage-icon">üõ£Ô∏è</span> Daily Driver
                        </div>
                        <div class="usage-option" onclick="selectUsage(this, 'track')">
                            <span class="usage-icon">üèÅ</span> Track / Racing
                        </div>
                        <div class="usage-option" onclick="selectUsage(this, 'offroad')">
                            <span class="usage-icon">üèîÔ∏è</span> Off-Road
                        </div>
                        <div class="usage-option" onclick="selectUsage(this, 'project')">
                            <span class="usage-icon">üîß</span> Project / Custom
                        </div>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-ghost" onclick="goToStep(1)">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">Continue ‚Üí</button>
                </div>
            </div>

            <!-- ====== STEP 3: Review & Register ====== -->
            <div class="setup-card" id="step3">
                <div id="reviewScreen">
                    <h2>üìã Review & Register</h2>
                    <p class="subtitle">Make sure everything looks good before registering.</p>

                    <div style="background:var(--light-background-color);padding:16px 20px;border-radius:10px;border:var(--brutal-border);margin-bottom:20px;">
                        <div class="device-found-row">
                            <span class="device-found-label">MAC Address</span>
                            <span class="device-found-val" id="reviewMAC">‚Äî</span>
                        </div>
                        <div class="device-found-row">
                            <span class="device-found-label">Name</span>
                            <span class="device-found-val" id="reviewName">‚Äî</span>
                        </div>
                        <div class="device-found-row">
                            <span class="device-found-label">Vehicle</span>
                            <span class="device-found-val" id="reviewCar">‚Äî</span>
                        </div>
                        <div class="device-found-row">
                            <span class="device-found-label">Usage</span>
                            <span class="device-found-val" id="reviewUsage">‚Äî</span>
                        </div>
                    </div>

                    <div class="btn-row">
                        <button class="btn btn-ghost" onclick="goToStep(2)">‚Üê Back</button>
                        <button class="btn btn-primary" id="registerBtn" onclick="registerDevice()">Register Device ‚úì</button>
                    </div>
                    <div class="status-msg" id="registerStatus" style="margin-top:12px;"></div>
                </div>

                <!-- Success (replaces review after submit) -->
                <div class="success-screen" id="successScreen" style="display:none;">
                    <div class="success-icon">üéâ</div>
                    <h2>Device Registered!</h2>
                    <p id="successMsg">Your device is linked to your account and ready to go.</p>
                    <div class="btn-row" style="justify-content:center;">
                        <a href="/devices"><button class="btn btn-primary">Go to My Devices ‚Üí</button></a>
                    </div>
                </div>
            </div>
        </div>

        {% include 'footer.html' %}

        <script>
        // ===== STATE =====
        let bleDevice = null;
        let bleServer = null;
        let selectedMAC = '';
        let selectedModule = 'ESP32-S3';
        let selectedBrand = '';
        let selectedModel = '';
        let selectedUsage = '';

        // ===== CAR DATABASE =====
        const CAR_DATA = {
            'Abarth': ['124 Spider','500','595','695','Punto'],
            'Alfa Romeo': ['147','156','159','166','4C','Giulia','Giulietta','MiTo','Stelvio','Tonale'],
            'Aston Martin': ['DB11','DB12','DBS','Rapide','Vantage','Vanquish','DBX'],
            'Audi': ['A1','A3','A4','A5','A6','A7','A8','Q2','Q3','Q5','Q7','Q8','R8','RS3','RS4','RS5','RS6','RS7','S3','S4','S5','S6','S7','S8','TT','TTS','TTRS','e-tron','e-tron GT','Q4 e-tron'],
            'BMW': ['1 Series','2 Series','3 Series','4 Series','5 Series','6 Series','7 Series','8 Series','X1','X2','X3','X4','X5','X6','X7','Z4','i3','i4','i7','iX','iX3','M2','M3','M4','M5','M8'],
            'Bentley': ['Bentayga','Continental GT','Flying Spur'],
            'Bugatti': ['Chiron','Divo','Mistral'],
            'Cadillac': ['CT4','CT5','Escalade','XT4','XT5','XT6'],
            'Chevrolet': ['Camaro','Corvette','Cruze','Malibu','Silverado','Spark','Tahoe','Trax','Blazer','Equinox'],
            'Chrysler': ['300','Pacifica'],
            'Citro√´n': ['Berlingo','C1','C3','C3 Aircross','C4','C4 Cactus','C5 Aircross','C5 X','DS3','DS4','DS5','DS7','√´-C4'],
            'Cupra': ['Ateca','Born','Formentor','Leon','Tavascan'],
            'Dacia': ['Duster','Jogger','Logan','Sandero','Spring'],
            'Dodge': ['Challenger','Charger','Durango','Hornet','RAM 1500'],
            'Ferrari': ['296 GTB','296 GTS','F8 Tributo','F8 Spider','SF90','Roma','Portofino','812','Purosangue'],
            'Fiat': ['500','500L','500X','Doblo','Ducato','Panda','Punto','Tipo'],
            'Ford': ['Bronco','EcoSport','Edge','Escape','Explorer','F-150','Fiesta','Focus','Galaxy','Kuga','Maverick','Mondeo','Mustang','Puma','Ranger','S-Max','Transit'],
            'Genesis': ['G70','G80','G90','GV60','GV70','GV80'],
            'Honda': ['Accord','Civic','CR-V','e:Ny1','HR-V','Jazz','NSX','ZR-V','Type R'],
            'Hyundai': ['Bayon','i10','i20','i30','Ioniq','Ioniq 5','Ioniq 6','Kona','Nexo','Santa Fe','Tucson','Veloster N'],
            'Infiniti': ['Q50','Q60','QX50','QX55','QX60','QX80'],
            'Jaguar': ['E-Pace','F-Pace','F-Type','I-Pace','XE','XF','XJ'],
            'Jeep': ['Avenger','Cherokee','Compass','Gladiator','Grand Cherokee','Renegade','Wrangler'],
            'Kia': ['Ceed','EV6','EV9','Niro','Picanto','Proceed','Seltos','Sorento','Sportage','Stinger','Stonic','XCeed'],
            'Lamborghini': ['Aventador','Hurac√°n','Revuelto','Urus'],
            'Land Rover': ['Defender','Discovery','Discovery Sport','Range Rover','Range Rover Evoque','Range Rover Sport','Range Rover Velar'],
            'Lexus': ['ES','IS','LC','LS','LX','NX','RC','RX','RZ','UX'],
            'Lotus': ['Eletre','Emira','Evija'],
            'Maserati': ['Ghibli','GranTurismo','Grecale','Levante','MC20','Quattroporte'],
            'Mazda': ['2','3','6','CX-3','CX-30','CX-5','CX-60','MX-5','MX-30'],
            'McLaren': ['720S','750S','765LT','Artura','GT','P1'],
            'Mercedes-Benz': ['A-Class','B-Class','C-Class','CLA','CLE','CLS','E-Class','EQA','EQB','EQC','EQE','EQS','G-Class','GLA','GLB','GLC','GLE','GLS','S-Class','SL','AMG GT','AMG A45','AMG C63','AMG E63'],
            'Mini': ['Clubman','Cooper','Countryman','Electric'],
            'Mitsubishi': ['ASX','Eclipse Cross','L200','Outlander','Space Star'],
            'Nissan': ['Ariya','GT-R','Juke','Leaf','Micra','Navara','Note','Qashqai','X-Trail','370Z','400Z'],
            'Opel': ['Astra','Combo','Corsa','Crossland','Grandland','Mokka','Insignia','Zafira'],
            'Peugeot': ['108','208','308','408','508','2008','3008','5008','e-208','e-308','e-2008','Rifter','Partner'],
            'Porsche': ['718 Boxster','718 Cayman','911','Cayenne','Macan','Panamera','Taycan'],
            'Renault': ['Arkana','Austral','Captur','Clio','Espace','Kangoo','Koleos','Megane','Megane E-Tech','Scenic','Talisman','Twingo','Zoe'],
            'Rolls-Royce': ['Cullinan','Dawn','Ghost','Phantom','Spectre','Wraith'],
            'Seat': ['Arona','Ateca','Ibiza','Leon','Tarraco'],
            'Skoda': ['Enyaq','Fabia','Kamiq','Karoq','Kodiaq','Octavia','Scala','Superb'],
            'Smart': ['EQ forfour','EQ fortwo','#1','#3'],
            'Subaru': ['BRZ','Crosstrek','Forester','Impreza','Legacy','Outback','WRX','XV'],
            'Suzuki': ['Across','Ignis','Jimny','S-Cross','Swift','Vitara'],
            'Tesla': ['Model 3','Model S','Model X','Model Y','Cybertruck'],
            'Toyota': ['Aygo','C-HR','Camry','Corolla','GR86','GR Supra','GR Yaris','Highlander','Hilux','Land Cruiser','Mirai','Prius','RAV4','Yaris','Yaris Cross','bZ4X'],
            'Volkswagen': ['Amarok','Arteon','Caddy','Golf','Golf GTI','Golf R','ID.3','ID.4','ID.5','ID.7','Passat','Polo','T-Cross','T-Roc','Taigo','Tiguan','Touareg','Touran','Up'],
            'Volvo': ['C40','EX30','EX90','S60','S90','V60','V90','XC40','XC60','XC90'],
            'Other': ['Custom / Kit Car','Electric Conversion','Classic Car','Motorcycle','Truck / Van','Other']
        };

        const brandNames = Object.keys(CAR_DATA).sort();

        // ===== BLE UUIDs (match your ESP32 firmware) =====
        const DEZZIP_SERVICE_UUID    = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHAR_BOARD_ID_UUID     = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const CHAR_WIFI_SSID_UUID    = 'beb5483e-36e1-4688-b7f5-ea07361b26a9';
        const CHAR_WIFI_PASS_UUID    = 'beb5483e-36e1-4688-b7f5-ea07361b26aa';
        const CHAR_MODULE_UUID       = 'beb5483e-36e1-4688-b7f5-ea07361b26ab';
        const CHAR_SERVER_URL_UUID   = 'beb5483e-36e1-4688-b7f5-ea07361b26ac';
        const CHAR_CLOUD_TOKEN_UUID  = 'beb5483e-36e1-4688-b7f5-ea07361b26ad';
        const CHAR_STATUS_UUID       = 'beb5483e-36e1-4688-b7f5-ea07361b26ae';
        const CHAR_CONFIG_JSON_UUID  = 'beb5483e-36e1-4688-b7f5-ea07361b26af';

        let bleService = null;  // cached BLE service reference

        // ===== STEP NAVIGATION =====
        function goToStep(n) {
            if (n === 2 && !selectedMAC) {
                const manual = document.getElementById('manualMAC').value.trim().toUpperCase();
                if (!manual) { alert('Please scan or enter a MAC address first.'); return; }
                selectedMAC = manual;
            }

            if (n === 3) {
                const mac = selectedMAC;
                const name = document.getElementById('deviceName').value.trim() || 'Device ' + mac.slice(-5);
                const brand = document.getElementById('brandInput').value.trim();
                const model = document.getElementById('modelInput').value.trim();
                const year = document.getElementById('carYear').value;

                document.getElementById('reviewMAC').textContent = mac;
                document.getElementById('reviewName').textContent = name;
                document.getElementById('reviewCar').textContent = (brand && model) ? brand + ' ' + model + (year ? ' (' + year + ')' : '') : 'Not specified';
                document.getElementById('reviewUsage').textContent = selectedUsage ? selectedUsage.charAt(0).toUpperCase() + selectedUsage.slice(1) : 'Not specified';
            }

            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById('stepDot' + i);
                const card = document.getElementById('step' + i);
                dot.classList.remove('active', 'done');
                card.classList.remove('active');
                if (i < n) dot.classList.add('done');
                else if (i === n) dot.classList.add('active');
            }
            document.getElementById('stepLine1').classList.toggle('done', n >= 2);
            document.getElementById('stepLine2').classList.toggle('done', n >= 3);
            document.getElementById('step' + n).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== BLE SCAN =====
        async function startScan() {
            if (!navigator.bluetooth) {
                setStatus('scanStatus', 'error', 'Bluetooth is not supported in this browser. Use Chrome or Edge, or enter the MAC address manually below.');
                return;
            }

            const btn = document.getElementById('scanBtn');
            const spinner = document.getElementById('scanSpinner');
            const btnText = document.getElementById('scanBtnText');
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Scanning...';
            setStatus('scanStatus', 'info', 'Looking for Dezzip devices nearby...');

            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'Dezzip' }],
                    optionalServices: [DEZZIP_SERVICE_UUID]
                });

                // Listen for disconnection
                bleDevice.addEventListener('gattserverdisconnected', onBleDisconnect);

                btnText.textContent = 'Connecting...';
                setStatus('scanStatus', 'info', 'Connecting to ' + bleDevice.name + '...');

                bleServer = await bleDevice.gatt.connect();
                bleService = await bleServer.getPrimaryService(DEZZIP_SERVICE_UUID);

                // Read board ID (MAC)
                try {
                    const boardIdChar = await bleService.getCharacteristic(CHAR_BOARD_ID_UUID);
                    const boardIdVal = await boardIdChar.readValue();
                    selectedMAC = new TextDecoder().decode(boardIdVal).trim().toUpperCase();
                } catch (e) { selectedMAC = ''; }

                // Read module type
                try {
                    const moduleChar = await bleService.getCharacteristic(CHAR_MODULE_UUID);
                    const moduleVal = await moduleChar.readValue();
                    selectedModule = new TextDecoder().decode(moduleVal).trim() || 'ESP32-S3';
                } catch (e) { selectedModule = 'ESP32-S3'; }

                // Subscribe to STATUS notifications
                try {
                    const statusChar = await bleService.getCharacteristic(CHAR_STATUS_UUID);
                    await statusChar.startNotifications();
                    statusChar.addEventListener('characteristicvaluechanged', onStatusNotify);
                } catch (e) { console.warn('STATUS notify setup failed:', e); }

                if (!selectedMAC) selectedMAC = bleDevice.name || 'UNKNOWN';

                // Show found device
                document.getElementById('foundName').textContent = bleDevice.name || '--';
                document.getElementById('foundMAC').textContent = selectedMAC;
                document.getElementById('foundModule').textContent = selectedModule;
                document.getElementById('deviceFound').classList.add('show');

                // Show WiFi form
                document.getElementById('wifiForm').classList.add('show');

                setStatus('scanStatus', 'success', 'Connected to ' + bleDevice.name + '!');
                spinner.style.display = 'none';
                btnText.textContent = 'Connected';

            } catch (err) {
                spinner.style.display = 'none';
                btn.disabled = false;
                btnText.textContent = 'Scan for Devices';

                if (err.name === 'NotFoundError') {
                    setStatus('scanStatus', 'error', 'No device selected. Try again or enter MAC manually.');
                } else {
                    setStatus('scanStatus', 'error', err.message || 'Connection failed. Make sure the device is powered on and nearby.');
                }
            }
        }

        // ===== BLE DISCONNECT HANDLER =====
        function onBleDisconnect() {
            bleServer = null;
            bleService = null;
            const btn = document.getElementById('scanBtn');
            btn.disabled = false;
            document.getElementById('scanBtnText').textContent = 'Reconnect';
            setStatus('scanStatus', 'error', 'Device disconnected. Click Reconnect to try again.');
        }

        // ===== STATUS NOTIFICATION HANDLER =====
        function onStatusNotify(event) {
            const val = new TextDecoder().decode(event.target.value);
            console.log('BLE STATUS:', val);

            if (val === 'WIFI_OK') {
                setStatus('wifiStatus', 'success', 'WiFi connected on the device!');
            } else if (val === 'WIFI_FAIL') {
                setStatus('wifiStatus', 'error', 'WiFi connection failed on device. Check credentials.');
            } else if (val === 'CONNECTING') {
                setStatus('wifiStatus', 'info', 'Device connecting to WiFi...');
            } else if (val === 'CLOUD_OK') {
                setStatus('registerStatus', 'success', 'Cloud link active on device!');
            }
        }

        // ===== BLE RECONNECT =====
        async function bleReconnect() {
            if (!bleDevice) return false;
            try {
                bleServer = await bleDevice.gatt.connect();
                bleService = await bleServer.getPrimaryService(DEZZIP_SERVICE_UUID);
                return true;
            } catch (e) {
                console.warn('BLE reconnect failed:', e);
                return false;
            }
        }

        // ===== HELPER: ensure BLE connected =====
        async function ensureBleConnected() {
            if (bleServer && bleServer.connected && bleService) return true;
            return await bleReconnect();
        }

        // ===== PUSH WIFI =====
        async function pushWifi() {
            const ssid = document.getElementById('wifiSSID').value.trim();
            const pass = document.getElementById('wifiPass').value;

            if (!ssid) { setStatus('wifiStatus', 'error', 'WiFi SSID is required.'); return; }

            try {
                if (!(await ensureBleConnected())) {
                    setStatus('wifiStatus', 'info', 'BLE disconnected. Skipping WiFi push.');
                    setTimeout(() => goToStep(2), 800);
                    return;
                }

                const encoder = new TextEncoder();
                setStatus('wifiStatus', 'info', 'Sending WiFi credentials...');

                const ssidChar = await bleService.getCharacteristic(CHAR_WIFI_SSID_UUID);
                await ssidChar.writeValue(encoder.encode(ssid));

                const passChar = await bleService.getCharacteristic(CHAR_WIFI_PASS_UUID);
                await passChar.writeValue(encoder.encode(pass));

                setStatus('wifiStatus', 'success', 'WiFi credentials sent! Waiting for device to connect...');

                // Wait a bit for STATUS notification (WIFI_OK/WIFI_FAIL) before moving on
                await new Promise(resolve => setTimeout(resolve, 3000));
                goToStep(2);

            } catch (err) {
                setStatus('wifiStatus', 'error', 'Failed to send WiFi: ' + (err.message || 'Unknown error'));
                setTimeout(() => goToStep(2), 2000);
            }
        }

        // ===== MANUAL MAC =====
        function toggleManual() {
            document.getElementById('manualSection').classList.toggle('show');
        }

        function useManualMAC() {
            const mac = document.getElementById('manualMAC').value.trim().toUpperCase();
            if (!mac) { alert('Enter a MAC address.'); return; }
            const macRegex = /^([0-9A-F]{2}:){5}[0-9A-F]{2}$/;
            if (!macRegex.test(mac)) { alert('Invalid MAC format. Expected: AA:BB:CC:DD:EE:FF'); return; }
            selectedMAC = mac;
            goToStep(2);
        }

        // ===== CAR BRAND / MODEL =====
        function filterBrands() {
            const q = document.getElementById('brandInput').value.toLowerCase();
            const dd = document.getElementById('brandDropdown');
            dd.innerHTML = '';
            const matches = brandNames.filter(b => b.toLowerCase().includes(q));
            if (matches.length === 0) { dd.classList.remove('open'); return; }
            matches.forEach(b => {
                const div = document.createElement('div');
                div.className = 'search-dropdown-item';
                div.textContent = b;
                div.onclick = () => selectBrand(b);
                dd.appendChild(div);
            });
            dd.classList.add('open');
        }

        function openBrandDropdown() { filterBrands(); }

        function selectBrand(brand) {
            selectedBrand = brand;
            document.getElementById('brandInput').value = brand;
            document.getElementById('brandDropdown').classList.remove('open');
            const modelInput = document.getElementById('modelInput');
            modelInput.disabled = false;
            modelInput.placeholder = 'Search model...';
            modelInput.value = '';
            selectedModel = '';
        }

        function filterModels() {
            if (!selectedBrand || !CAR_DATA[selectedBrand]) return;
            const q = document.getElementById('modelInput').value.toLowerCase();
            const dd = document.getElementById('modelDropdown');
            dd.innerHTML = '';
            const models = CAR_DATA[selectedBrand].filter(m => m.toLowerCase().includes(q));
            if (models.length === 0) { dd.classList.remove('open'); return; }
            models.forEach(m => {
                const div = document.createElement('div');
                div.className = 'search-dropdown-item';
                div.textContent = m;
                div.onclick = () => selectModel(m);
                dd.appendChild(div);
            });
            dd.classList.add('open');
        }

        function openModelDropdown() { filterModels(); }

        function selectModel(model) {
            selectedModel = model;
            document.getElementById('modelInput').value = model;
            document.getElementById('modelDropdown').classList.remove('open');
        }

        // Close dropdowns on outside click
        document.addEventListener('click', e => {
            if (!e.target.closest('#brandWrap')) document.getElementById('brandDropdown').classList.remove('open');
            if (!e.target.closest('#modelWrap')) document.getElementById('modelDropdown').classList.remove('open');
        });

        // ===== USAGE =====
        function selectUsage(el, usage) {
            document.querySelectorAll('.usage-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedUsage = usage;
        }

        // ===== REGISTER =====
        async function registerDevice() {
            const mac = selectedMAC;
            const name = document.getElementById('deviceName').value.trim();
            const brand = document.getElementById('brandInput').value.trim();
            const model = document.getElementById('modelInput').value.trim();
            const year = document.getElementById('carYear').value;

            if (!mac) { setStatus('registerStatus', 'error', 'MAC address is missing.'); return; }

            const btn = document.getElementById('registerBtn');
            btn.disabled = true;
            btn.textContent = 'Registering...';
            setStatus('registerStatus', 'info', 'Registering device on server...');

            try {
                const formData = new FormData();
                formData.append('hardware_id', mac);
                formData.append('name', name || 'Device ' + mac.slice(-5));
                formData.append('module_type', selectedModule);
                formData.append('car_brand', brand);
                formData.append('car_model', model);
                formData.append('car_year', year);
                formData.append('usage', selectedUsage);
                formData.append('ajax', '1');

                const resp = await fetch('{{ url_for("devices.register_device") }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await resp.json();

                if (data.status === 'ok') {
                    // Push SERVER_URL + CLOUD_TOKEN to ESP32 via BLE
                    await pushCloudCredentials(data.token);

                    document.getElementById('reviewScreen').style.display = 'none';
                    document.getElementById('successScreen').style.display = 'block';
                    document.getElementById('stepDot3').classList.add('done');
                    document.getElementById('stepDot3').classList.remove('active');
                } else {
                    setStatus('registerStatus', 'error', (data.error || 'Registration failed.'));
                    btn.disabled = false;
                    btn.textContent = 'Register Device';
                }
            } catch (err) {
                setStatus('registerStatus', 'error', 'Network error: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Register Device';
            }
        }

        // ===== PUSH CLOUD CREDENTIALS VIA BLE =====
        async function pushCloudCredentials(cloudToken) {
            if (!(await ensureBleConnected())) {
                console.warn('BLE not connected, skipping cloud push');
                document.getElementById('successMsg').textContent =
                    'Device registered! Cloud credentials could not be sent via Bluetooth (device disconnected). ' +
                    'The device will sync when connected to WiFi.';
                return;
            }

            try {
                const encoder = new TextEncoder();
                setStatus('registerStatus', 'info', 'Sending cloud credentials to device...');

                // Build server URL from current page origin
                const serverUrl = window.location.origin + '/api/v1';

                const urlChar = await bleService.getCharacteristic(CHAR_SERVER_URL_UUID);
                await urlChar.writeValue(encoder.encode(serverUrl));

                const tokenChar = await bleService.getCharacteristic(CHAR_CLOUD_TOKEN_UUID);
                await tokenChar.writeValue(encoder.encode(cloudToken));

                setStatus('registerStatus', 'success', 'Cloud credentials sent to device!');

                // Wait for CLOUD_OK notification
                await new Promise(resolve => setTimeout(resolve, 2000));

                document.getElementById('successMsg').textContent =
                    'Device registered and cloud link activated! Your gauge is ready.';

            } catch (err) {
                console.warn('BLE cloud push failed:', err);
                document.getElementById('successMsg').textContent =
                    'Device registered! Cloud credentials could not be sent via Bluetooth. ' +
                    'Configure WiFi and cloud manually from the device settings page.';
            }
        }

        // ===== UTILS =====
        function setStatus(id, type, msg) {
            const el = document.getElementById(id);
            el.className = 'status-msg ' + type;
            el.textContent = msg;
        }
        </script>
    </body>
</html>
