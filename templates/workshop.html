<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/css/style.css" />
    <link rel="stylesheet" href="/static/css/post.css" />
    <link rel="stylesheet" href="/static/css/navbar.css"/>
    <link rel="stylesheet" href="/static/css/footer.css"/>
    <link rel="stylesheet" href="/static/css/common.css"/>
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap' rel='stylesheet'>
    <title>Workshop - Dezzip</title>
    <style>
      .post-filters {
        display: flex;
        gap: var(--space-md);
        flex-wrap: wrap;
      }

      .filter {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
      }

      .filter h3 {
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--text-muted);
      }

      .filter select {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        color: var(--text-color);
        padding: 8px 36px 8px 12px;
        font-size: var(--font-size-sm);
        backdrop-filter: blur(8px);
        transition: all var(--transition-normal);
        cursor: pointer;
        width: auto;
      }

      .filter select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px var(--accent-color-dim);
      }
    </style>
  </head>
  <body>
    {% include 'navbar.html' %}

    <div class="page">
      <div class="page-header">
        <div class="page-header-content margined">
          <div class="title">
            <div>
              <span style="font-size: var(--font-size-xs); text-transform: uppercase; letter-spacing: 3px; color: var(--accent-color); font-weight: 600;">Community</span>
              <h1 style="margin-top: 4px;">Workshop</h1>
            </div>
            <a href="/workshop/upload">
              <button class="btn btn-primary">Upload a Gauge Face</button>
            </a>
          </div>

          <div class="post-filters">
            <div class="filter">
              <h3>Sort:</h3>
              <select id="sortDropdown">
                <option value="sort=new">New</option>
                <option value="sort=top">Top</option>
                <option value="sort=most_downloaded">Most Downloaded</option>
                <option value="featured=true">Featured</option>
                <option value="sort=trending">Trending</option>
              </select>
            </div>

            <div class="filter">
              <h3>Type:</h3>
              <select id="typeDropdown">
                <option value="type=all">All</option>
                <option value="type=tachometer">Tachometer</option>
                <option value="type=speedometer">Speedometer</option>
                <option value="type=boost">Boost</option>
                <option value="type=temperature">Temperature</option>
                <option value="type=fuel-level">Fuel Level</option>
                <option value="type=voltmeter">Voltmeter</option>
                <option value="type=other">Hybrid/Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="page-content margined">
        {% if posts %}
          <div class="post-grid">
            {% import 'macros/post_card.html' as post_macros %}
            {% for post in posts %}
              {{ post_macros.render_post(post, show_user=True, show_feature_star=True) }}
            {% endfor %}
          </div>
        {% else %}
          <div style="text-align: center; padding: var(--space-2xl) 0;">
            <p style="color: var(--text-muted);">No posts found!</p>
          </div>
        {% endif %}

        {% if pagination.pages > 1 %}
          <div class="pagination">
            {% if pagination.has_prev %}
              <a href="{{ url_for('workshop', page=pagination.prev_num, sort=sort_option, type=request.args.get('type'), featured=request.args.get('featured')) }}">Previous</a>
            {% endif %}
            Page {{ pagination.page }} of {{ pagination.pages }}
            {% if pagination.has_next %}
              <a href="{{ url_for('workshop', page=pagination.next_num, sort=sort_option, type=request.args.get('type'), featured=request.args.get('featured')) }}">Next</a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    {% include 'footer.html' %}

    <script src="/static/js/gaugePreview.js" type="module"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.like-form, .favorite-form').forEach(form => {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = form.dataset.id;
            const action = form.dataset.action;
            const url = `/workshop/${postId}/${action}`;
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (response.ok) {
              const data = await response.json();
              const icon = form.querySelector('img');
              if (data.liked !== undefined) {
                icon.src = data.liked ? '/static/images/liked.png' : '/static/images/not_liked.png';
              } else if (data.favorited !== undefined) {
                icon.src = data.favorited ? '/static/images/favorited.png' : '/static/images/not_favorited.png';
              }
            }
          });
        });
      });
    </script>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const sortDropdown = document.getElementById('sortDropdown');
        const typeDropdown = document.getElementById('typeDropdown');
        const activeParams = new Set();
        for (const [key, value] of params.entries()) {
          activeParams.add(`${key}=${value}`);
        }
        for (const option of sortDropdown.options) {
          if (activeParams.has(option.value)) { option.selected = true; break; }
        }
        for (const option of typeDropdown.options) {
          if (activeParams.has(option.value)) { option.selected = true; break; }
        }
        function updateURL() {
          const queryParams = [sortDropdown.value, typeDropdown.value].join("&");
          window.location.href = "/workshop?" + queryParams;
        }
        sortDropdown.addEventListener("change", updateURL);
        typeDropdown.addEventListener("change", updateURL);
      });
    </script>
  </body>
</html>
